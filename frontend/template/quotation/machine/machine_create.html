<!--machine_reate.html-->

{% extends "template/base.html" %}

{% block title %}장비 견적서 생성 - SYNEX+{% endblock %}

{% block extra_css %}
    <!-- 페이지 전용 CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/page/quotation/machine/machine_create.css') }}">
{% endblock %}

{% block content %}
<div class="page-content">
    {# 상단 정보 입력 #}
    <div class="create-header">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <h2 style="margin: 0;">장비 견적서 생성</h2>
            <span id="autoSaveStatus" style="font-size: 13px; color: #6b7280; font-weight: normal;"></span>
        </div>
        <div class="header-form">
            <div class="form-row">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 6px;">
                        <label for="machineName" style="margin-bottom: 0;">장비명 <span class="required">*</span></label>
	                        <button id="importBtn" class="btn btn-secondary btn-sm" onclick="openImportModal()" style="padding: 4px 12px; font-size: 13px; height: 30px;">
	                            기존 장비 불러오기
	                        </button>
                    </div>
                    <input type="text" id="machineName" class="form-input" placeholder="장비명을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label for="manufacturer">장비사</label>
                    <input type="text" id="manufacturer" class="form-input" placeholder="장비사를 입력하세요">
                </div>
                <div class="form-group">
                    <label for="client">고객사</label>
                    <input type="text" id="client" class="form-input" placeholder="고객사를 입력하세요">
                </div>
                <div class="form-group">
                    <label for="creator">작성자 <span class="required">*</span></label>
                    <input type="text" id="creator" class="form-input" placeholder="작성자명을 입력하세요" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="totalPrice">금액</label>
                    <input type="text" id="totalPrice" class="form-input" value="0원" readonly>
                </div>
                <div class="form-group">
                    <label for="createdAt">생성일</label>
                    <input type="text" id="createdAt" class="form-input" value="-" readonly>
                </div>
                <div class="form-group">
                    <label for="updatedAt">수정일</label>
                    <input type="text" id="updatedAt" class="form-input" value="-" readonly>
                </div>
                <div class="form-group">
                    <label for="description">비고</label>
                    <input type="text" id="description" class="form-input" placeholder="비고를 입력하세요">
                </div>
            </div>
        </div>
    </div>

    <hr class="divider">

    {# 부품 검색 #}
    <div class="action-bar">
        <div class="action-bar-left">
            <h3>부품 선택</h3>
        </div>
	        <div class="action-bar-right">
	            <button id="togglePartsViewBtn" class="btn btn-secondary" onclick="togglePartsView()" style="white-space: nowrap;">
	                부품 순서 보기
	            </button>
	            <span id="insertStatus" style="font-size: 13px; color: #6b7280;"></span>
	            <button id="cancelInsertBtn" class="btn btn-secondary btn-sm" onclick="clearInsertMode()" style="padding: 4px 12px; font-size: 13px; height: 30px; display:none;">
	                삽입 취소
	            </button>
	            <select class="input-select" id="categoryFilter" onchange="loadParts()">
	                <option value="">전체 카테고리</option>
	                <option value="판넬">판넬</option>
	                <option value="잡재료 및 케이블">잡재료 및 케이블</option>
	            </select>
            <input type="text" class="input-search" placeholder="부품명 검색" id="searchInput" onkeypress="handleSearch(event)">
            <button class="btn btn-primary" onclick="loadParts()">검색하기</button>
        </div>
    </div>

    {# 로딩 인디케이터 #}
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <p>데이터를 불러오는 중...</p>
    </div>

    {# 부품 선택 테이블 #}
    <div id="tableContainer"></div>

    {# 집계 테이블 #}
    <div class="summary-table-section" style="margin-top: 24px;">
        <div class="table-container">
            <table class="data-table create-table" id="summaryTable">
                <thead>
                    <tr>
                        <th class="col-center" style="width: 120px">Unit</th>
                        <th class="col-left" style="width: 120px">품목</th>
                        <th class="col-left" style="width: 200px">모델명/규격</th>
                        <th class="col-left" style="width: 100px">Maker</th>
                        <th class="col-center" style="width: 50px">UL</th>
                        <th class="col-center" style="width: 50px">CE</th>
                        <th class="col-center" style="width: 50px">KC</th>
                        <th class="col-center" style="width: 100px">기타</th>
                        <th class="col-center" style="width: 60px">단위</th>
                        <th class="col-right" style="width: 120px">금액</th>
                        <th class="col-center" style="width: 100px">수량</th>
                        <th class="col-right" style="width: 120px">합계 금액</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    {# 전장/제어부 집계 그룹 #}
                    <tr data-summary-type="auto" data-category="전장 판넬 판금 및 명판">
                        <td class="col-center category-cell labor-header-cell" rowspan="9"><strong>전장/제어부<br>집계</strong></td>
                        <td class="col-left summary-readonly" colspan="8"><strong>전장 판넬 판금 및 명판</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="판넬 차단기류">
                        <td class="col-left summary-readonly" colspan="8"><strong>판넬 차단기류</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="PLC Set">
                        <td class="col-left summary-readonly" colspan="8"><strong>PLC Set</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="Touch Screen">
                        <td class="col-left summary-readonly" colspan="8"><strong>Touch Screen</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="판넬 주요자재">
                        <td class="col-left summary-readonly" colspan="8"><strong>판넬 주요자재</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="판넬 기타자재">
                        <td class="col-left summary-readonly" colspan="8"><strong>판넬 기타자재</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="auto" data-category="케이블 및 기타 잡자재">
                        <td class="col-left summary-readonly" colspan="8"><strong>케이블 및 기타 잡자재</strong></td>
                        <td class="col-right summary-readonly">-</td>
                        <td class="col-center summary-qty">0</td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="manual" data-item="LOCAL_MAT" class="manual-input-row">
                        <td class="col-left" colspan="8"><strong>Local 자재</strong></td>
                        <td class="col-right">
                            <input type="number" class="price-input manual-summary-input" data-item="LOCAL_MAT" value="0" min="0" onchange="updateManualSummary('LOCAL_MAT', 'price', this.value)">
                        </td>
                        <td class="col-center">
                            <input type="number" class="quantity-input manual-summary-input" data-item="LOCAL_MAT" value="0" min="0" onchange="updateManualSummary('LOCAL_MAT', 'quantity', this.value)">
                        </td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    <tr data-summary-type="manual" data-item="OPERATION_PC" class="manual-input-row">
                        <td class="col-left" colspan="8"><strong>운영 PC/주액 PC</strong></td>
                        <td class="col-right">
                            <input type="number" class="price-input manual-summary-input" data-item="OPERATION_PC" value="0" min="0" onchange="updateManualSummary('OPERATION_PC', 'price', this.value)">
                        </td>
                        <td class="col-center">
                            <input type="number" class="quantity-input manual-summary-input" data-item="OPERATION_PC" value="0" min="0" onchange="updateManualSummary('OPERATION_PC', 'quantity', this.value)">
                        </td>
                        <td class="col-right summary-amount">0</td>
                    </tr>
                    
                    {# 자재 합계 #}
                    <tr class="material-total-row">
                        <td class="col-center" colspan="11"><strong>자재 합계</strong></td>
                        <td class="col-right"><strong id="materialTotalAmount">0</strong></td>
                    </tr>
                    
                    {# 인건비 섹션 (JS로 자동 렌더링됨) #}
                    
                    {# 인건비 합계 #}
                    <tr class="labor-total-row" id="laborRowsPlaceholder">
                        <td class="col-center"><strong>인건비 합계</strong></td>
                        <td class="col-left" colspan="10"></td>
                        <td class="col-right"><strong id="laborTotalAmount">0</strong></td>
                    </tr>
                    
                    {# 자재 & 인건비 합계 #}
                    <tr class="grand-total-row">
                        <td class="col-center" colspan="11"><strong>자재 & 인건비 합계</strong></td>
                        <td class="col-right"><strong id="grandTotalAmount">0</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    {# 등록 버튼 #}
    <div class="action-footer">
        <button class="btn btn-secondary btn-lg" onclick="goBack()">취소</button>
        <button class="btn btn-success btn-lg" onclick="submitMachine()" id="submitBtn">등록완료</button>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="floating-action-buttons">
    <button id="fabSaveBtn" class="fab-btn" onclick="saveDraft()" title="임시 저장">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
    </button>
    <button id="fabSubmitBtn" class="fab-btn submit-fab" onclick="submitMachine()" title="등록 완료">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
    </button>
    <button id="fabEditBtn" class="fab-btn" onclick="switchToEditMode()" title="수정하기" style="display: none; background-color: #f59e0b;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
</div>

<!-- Part Registration Modal -->
<div id="createModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>부품 등록</h3>
            <button class="close-btn" onclick="closeCreatePopup()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Maker <span class="required">*</span></label>
                    <select id="regMaker" class="form-input" required>
                        <option value="" disabled selected>제조사를 선택해주세요</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unit (대분류) <span class="required">*</span></label>
                    <select id="regMajor" class="form-input" required onchange="toggleMajorManual()">
                        <option value="전장 판넬 판금 및 명판">전장 판넬 판금 및 명판</option>
                        <option value="판넬 차단기류">판넬 차단기류</option>
                        <option value="PLC Set">PLC Set</option>
                        <option value="Touch Screen">Touch Screen</option>
                        <option value="판넬 주요자재">판넬 주요자재</option>
                        <option value="판넬 기타자재">판넬 기타자재</option>
                        <option value="케이블 및 기타 잡자재">케이블 및 기타 잡자재</option>
                        <option value="기타">기타 (직접 입력)</option>
                    </select>
                    <input type="text" id="regMajorManual" class="form-input" placeholder="대분류 입력" style="display: none; margin-top: 8px;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>품목 (중분류) <span class="required">*</span></label>
                    <input type="text" id="regMinor" class="form-input" placeholder="예: Circuit Breaker" required>
                </div>
                <div class="form-group">
                    <label>모델명/규격 <span class="required">*</span></label>
                    <input type="text" id="regName" class="form-input" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>단위 <span class="required">*</span></label>
                    <input type="text" id="regUnit" class="form-input" value="ea" required>
                </div>
                <div class="form-group">
                    <label>금액 <span class="required">*</span></label>
                    <input type="number" id="regPrice" class="form-input" min="0" value="0" required>
                </div>
            </div>
            <div class="form-group">
                <label>인증</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="regUL"> UL</label>
                    <label><input type="checkbox" id="regCE"> CE</label>
                    <label><input type="checkbox" id="regKC"> KC</label>
                </div>
            </div>
            <div class="form-group">
                <label>기타 인증/비고</label>
                <input type="text" id="regEtc" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreatePopup()">취소</button>
            <button class="btn btn-primary" onclick="submitCreatePart()">등록</button>
        </div>
    </div>
</div>

	<!-- Import Modal -->
	<div id="importModal" class="modal-overlay" style="display: none;">
	    <div class="modal-content" style="max-width: 800px;">
	        <div class="modal-header">
	            <h3>기존 장비 불러오기</h3>
	            <button class="close-btn" onclick="closeImportModal()">×</button>
	        </div>
	        <div class="modal-body">
	            <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
	                <input id="importSearchInput" type="text" class="form-input" placeholder="템플릿 검색 (기본: [TEMPLATE])" style="flex: 1;" onkeypress="handleImportSearch(event)">
	                <button class="btn btn-primary" onclick="loadImportMachines()">검색</button>
	            </div>
	            <div id="importLoading" style="display:none; text-align:center; padding: 16px; color:#6b7280;">불러오는 중...</div>
	            <div id="importListContainer"></div>
	        </div>
	        <div class="modal-footer">
	            <button class="btn btn-secondary" onclick="closeImportModal()">취소</button>
	            <button id="importApplyBtn" class="btn btn-primary" onclick="applyImportSelection()" disabled>불러오기</button>
	        </div>
	    </div>
	</div>
{% endblock %}

{% block extra_js %}
    <!-- 페이지 전용 JS -->
    <script src="{{ url_for('static', path='/js/page/quotation/machine/machine_create.js') }}"></script>
{% endblock %}