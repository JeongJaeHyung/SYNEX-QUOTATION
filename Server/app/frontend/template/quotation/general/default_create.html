{% extends "template/base.html" %}

{% block title %}ê²¬ì ì„œ(ì¼ë°˜) - SYNEX+{% endblock %}

{% block content %}
<div class="page-content">
    {# ìƒë‹¨ ì •ë³´ ì…ë ¥ #}
    <div class="create-header">
        <h2 id="pageTitle">ê²¬ì ì„œ(ì¼ë°˜) ìƒì„±</h2>
        <div class="header-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="generalName">ê²¬ì ì„œëª… <span class="required">*</span></label>
                    <input type="text" id="generalName" class="form-input" placeholder="ê²¬ì ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="form-group">
                    <label for="client">ê³ ê°ì‚¬</label>
                    <input type="text" id="client" class="form-input" placeholder="ê³ ê°ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label for="creator">ì‘ì„±ì <span class="required">*</span></label>
                    <input type="text" id="creator" class="form-input" placeholder="ì‘ì„±ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="form-group">
                    <label for="description">ë¹„ê³ </label>
                    <input type="text" id="description" class="form-input" placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            <div class="form-row" id="viewOnlyFields" style="display: none;">
                <div class="form-group">
                    <label for="createdAt">ìƒì„±ì¼</label>
                    <input type="text" id="createdAt" class="form-input" value="-" readonly>
                </div>
                <div class="form-group">
                    <label for="updatedAt">ìˆ˜ì •ì¼</label>
                    <input type="text" id="updatedAt" class="form-input" value="-" readonly>
                </div>
            </div>
        </div>
    </div>

    {# ì—°ê´€ í…Œì´ë¸” ì„¹ì…˜ (View ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) #}
    <div id="relationsSection" style="display: none;">
        <hr class="divider">
        
        <div class="section-header">
            <h3>ì—°ê´€ ê²¬ì ì„œ ëª©ë¡</h3>
            <p class="section-description">ì´ ê²¬ì ì„œ(ì¼ë°˜)ì— ì—°ê²°ëœ ê²¬ì ì„œ(ë¶€í’ˆ), ê²¬ì ì„œ(ìƒì„¸), ê²¬ì ì„œ(ë¹„êµ) ëª©ë¡</p>
        </div>

        {# ë¡œë”© ì¸ë””ì¼€ì´í„° #}
        <div id="relationsLoading" style="display: none; text-align: center; padding: 20px;">
            <p>ì—°ê´€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        {# ì—°ê´€ í…Œì´ë¸” #}
        <div id="relationsTableContainer"></div>
    </div>

    {# ì•¡ì…˜ í‘¸í„° (ë²„íŠ¼ ì˜ì—­) #}
    <div class="action-footer">
        <div id="derivativeBtnGroup" class="derivative-group" style="display: none;">
            <button class="btn btn-secondary" onclick="alert('ê²¬ì ì„œ(ê°‘ì§€) ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘')">ğŸ“„ ê°‘ì§€ ë§Œë“¤ê¸°</button>
            <button class="btn btn-secondary" onclick="alert('ê²¬ì ì„œ(ì„ì§€) ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘')">ğŸ“‘ ì„ì§€ ë§Œë“¤ê¸°</button>
            <button class="btn btn-primary" onclick="createPriceCompare()">ğŸ’° ë‚´ì •ê°€ ê²¬ì ë¹„êµì„œ ë§Œë“¤ê¸°</button>
        </div>

        <div class="right-group">
            <button class="btn btn-secondary btn-lg" onclick="goToList()">ëª©ë¡ìœ¼ë¡œ</button>
            <button class="btn btn-success btn-lg" onclick="submitGeneral()" id="submitBtn">ë“±ë¡ì™„ë£Œ</button>
        </div>
    </div>
</div>

<script>
// í˜ì´ì§€ ëª¨ë“œ ë° ID
let pageMode = 'create'; // create, view
let generalId = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ëª¨ë“œì™€ ID ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    pageMode = urlParams.get('mode') || 'create';
    generalId = urlParams.get('id') || null;
    
    // í˜ì´ì§€ ì´ˆê¸°í™”
    initializePage();
});

// í˜ì´ì§€ ì´ˆê¸°í™”
function initializePage() {
    const titleElement = document.getElementById('pageTitle');
    const submitBtn = document.getElementById('submitBtn');
    const viewOnlyFields = document.getElementById('viewOnlyFields');
    const relationsSection = document.getElementById('relationsSection');
    const derivativeBtnGroup = document.getElementById('derivativeBtnGroup'); // ì¶”ê°€ë¨
    
    if (pageMode === 'create') {
        // ìƒì„± ëª¨ë“œ
        titleElement.textContent = 'ê²¬ì ì„œ(ì¼ë°˜) ìƒì„±';
        submitBtn.textContent = 'ë“±ë¡ì™„ë£Œ';
        submitBtn.style.display = 'inline-block';
        viewOnlyFields.style.display = 'none';
        relationsSection.style.display = 'none';
        derivativeBtnGroup.style.display = 'none'; // ìƒì„± ì¤‘ì—” ìˆ¨ê¹€
        
    } else if (pageMode === 'view') {
        // ì¡°íšŒ ëª¨ë“œ - ëª¨ë“  í•„ë“œ ë¹„í™œì„±í™”
        titleElement.textContent = 'ê²¬ì ì„œ(ì¼ë°˜) ì¡°íšŒ';
        submitBtn.style.display = 'none'; // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€ (í•„ìš”ì‹œ ìˆ˜ì •ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
        viewOnlyFields.style.display = 'flex';
        relationsSection.style.display = 'block';
        derivativeBtnGroup.style.display = 'flex'; // [í•µì‹¬] íŒŒìƒ ë²„íŠ¼ ë³´ì„
        
        // ì…ë ¥ í•„ë“œ ëª¨ë‘ ë¹„í™œì„±í™”
        disableAllInputs();
        
        // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
        if (generalId) {
            loadGeneralData(generalId);
            loadRelationsData(generalId);
        }
    }
}

// [ì¶”ê°€ëœ í•¨ìˆ˜] ë‚´ì •ê°€ ë¹„êµì„œ ë§Œë“¤ê¸° í˜ì´ì§€ ì´ë™
function createPriceCompare() {
    if (!generalId) return alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
    // ìš°ë¦¬ê°€ ë§Œë“  ì„œë¸Œ í˜ì´ì§€ë¡œ ì´ë™ (General ID ì „ë‹¬)
    window.location.href = `/service/quotation/general/price_compare/register?general_id=${generalId}`;
}

// ëª¨ë“  ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™” (View ëª¨ë“œ)
function disableAllInputs() {
    document.getElementById('generalName').readOnly = true;
    document.getElementById('client').readOnly = true;
    document.getElementById('creator').readOnly = true;
    document.getElementById('description').readOnly = true;
}

// ê¸°ì¡´ General ë°ì´í„° ë¡œë“œ
async function loadGeneralData(id) {
    try {
        const response = await fetch(`/api/v1/quotation/general/${id}`);
        
        if (!response.ok) {
            throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        
        // ìƒë‹¨ ì •ë³´ ì„¤ì • (Response basic êµ¬ì¡° ëŒ€ì‘)
        const info = data.general || data; // êµ¬ì¡° ìœ ì—°í•˜ê²Œ ì²˜ë¦¬

        document.getElementById('generalName').value = info.name || '';
        document.getElementById('client').value = info.client || '';
        document.getElementById('creator').value = info.creator || '';
        document.getElementById('description').value = info.description || '';
        
        // ë‚ ì§œ í¬ë§·íŒ…
        if (info.created_at) {
            const createdDate = new Date(info.created_at);
            document.getElementById('createdAt').value = formatDateTime(createdDate);
        }
        if (info.updated_at) {
            const updatedDate = new Date(info.updated_at);
            document.getElementById('updatedAt').value = formatDateTime(updatedDate);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì—°ê´€ í…Œì´ë¸” ë°ì´í„° ë¡œë“œ
async function loadRelationsData(id) {
    const loading = document.getElementById('relationsLoading');
    const tableContainer = document.getElementById('relationsTableContainer');
    
    loading.style.display = 'block';
    tableContainer.innerHTML = '';
    
    try {
        // API í˜¸ì¶œ
        const response = await fetch(`/api/v1/quotation/general/${id}?include_relations=true`);
        
        if (!response.ok) {
            throw new Error('ì—°ê´€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        
        // ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ ì •ì˜
        const schema = data.schema || {
            "category": { "title": "êµ¬ë¶„", "type": "string", "ratio": 1 },
            "title": { "title": "ì œëª©/ë¹„ê³ ", "type": "string", "ratio": 3 },
            "creator": { "title": "ì‘ì„±ì", "type": "string", "ratio": 1 },
            "updated_at": { "title": "ìµœì¢…ìˆ˜ì •ì¼", "type": "datetime", "format": "YYYY-MM-DD HH:mm", "ratio": 1.5 }
        };
        
        // ë°ì´í„° í•„ë“œëª… ë§¤í•‘ (API ì‘ë‹µ -> í…Œì´ë¸” í‘œì‹œìš©)
        const items = data.related_documents || data.items || [];

        // ì—°ê´€ í…Œì´ë¸” ë Œë”ë§
        renderRelationsTable(schema, items);
        
    } catch (error) {
        console.error('Error:', error);
        tableContainer.innerHTML = '<div class="empty-state">ì—°ê´€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    } finally {
        loading.style.display = 'none';
    }
}

// ì—°ê´€ í…Œì´ë¸” ë Œë”ë§
function renderRelationsTable(schema, items) {
    const tableContainer = document.getElementById('relationsTableContainer');
    
    if (!items || items.length === 0) {
        tableContainer.innerHTML = '<div class="empty-state">ì—°ê´€ëœ ê²¬ì ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    
    let totalRatio = 0;
    for (const key in schema) {
        totalRatio += schema[key].ratio || 1;
    }
    
    let html = '<div class="table-container"><table class="data-table" id="relationsTable">';
    
    html += '<thead><tr>';
    for (const key in schema) {
        const col = schema[key];
        const width = ((col.ratio || 1) / totalRatio * 100).toFixed(1);
        html += `<th class="col-left" style="width: ${width}%">${col.title}</th>`;
    }
    html += '</tr></thead><tbody>';
    
    items.forEach((item) => {
        const relationId = item.id;
        const tableName = item.table_name;
        
        let detailUrl = '#';

        // â–¼â–¼â–¼ [í•µì‹¬ ìˆ˜ì • ë¶€ë¶„] í…Œì´ë¸” ì´ë¦„ì— ë”°ë¥¸ ìƒì„¸ í˜ì´ì§€ ë§¤í•‘ â–¼â–¼â–¼
        if (tableName === 'Quotation' || tableName === 'Machine' || tableName === 'ì¥ë¹„ ê²¬ì ì„œ') { 
            // ì¥ë¹„ ê²¬ì ì„œ ìƒì„¸ (mode=view)
            detailUrl = `/service/quotation/machine/form?mode=view&id=${relationId}`;
        } 
        else if (tableName === 'Detailed' || tableName === 'ê²¬ì ì„œ(ìƒì„¸)') {
            // ì„ì§€ ìƒì„¸ (mode=view)
            detailUrl = `/service/quotation/detailed/form?mode=view&id=${relationId}`;
        } 
        else if (tableName === 'PriceCompare' || tableName === 'ë‚´ì •ê°€ë¹„êµ' || tableName === 'ë¹„êµ ê²¬ì ì„œ') { 
            // [ì¤‘ìš”] ë‚´ì •ê°€ ë¹„êµì„œ ìƒì„¸ í˜ì´ì§€ (/detail/{id})
            detailUrl = `/service/quotation/general/price_compare/detail/${relationId}`;
        }
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
        
        html += `<tr class="clickable" onclick="window.location.href='${detailUrl}'">`;
        
        for (const key in schema) {
            const col = schema[key];
            const value = item[key];
            
            html += `<td class="col-left">`;
            if (key === 'table_name') {
                html += formatTableName(value);
            } else {
                html += formatValue(value, col.type, col.format);
            }
            html += '</td>';
        }
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    tableContainer.innerHTML = html;
}

function formatTableName(tableName) {
    // ë±ƒì§€ í‘œì‹œ ë¡œì§
    const badges = {
        'Quotation': '<span class="badge badge-primary">ì¥ë¹„ ê²¬ì ì„œ</span>',
        'Machine': '<span class="badge badge-primary">ì¥ë¹„ ê²¬ì ì„œ</span>',
        'Detailed': '<span class="badge badge-info">ê²¬ì ì„œ(ìƒì„¸)</span>',
        'PriceCompare': '<span class="badge badge-warning">ë‚´ì •ê°€ ë¹„êµ</span>',
        'ë¹„êµ ê²¬ì ì„œ': '<span class="badge badge-warning">ë‚´ì •ê°€ ë¹„êµ</span>' // í•œê¸€ ì´ë¦„ ëŒ€ì‘
    };
    return badges[tableName] || tableName;
}

function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

function formatValue(value, type, format) {
    if (value === null || value === undefined || value === '') {
        return '<span class="text-muted">-</span>';
    }
    switch(type) {
        case 'datetime':
            if (format === 'YYYY-MM-DD HH:mm') return value.substring(0, 16).replace('T', ' ');
            return value;
        case 'date':
            return value.substring(0, 10).replace(/-/g, '. ');
        default:
            return value;
    }
}

async function submitGeneral() {
    const generalName = document.getElementById('generalName').value.trim();
    const client = document.getElementById('client').value.trim();
    const creator = document.getElementById('creator').value.trim();
    const description = document.getElementById('description').value.trim();
    
    if (!generalName) { alert('ê²¬ì ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); document.getElementById('generalName').focus(); return; }
    if (!creator) { alert('ì‘ì„±ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); document.getElementById('creator').focus(); return; }
    
    const requestData = {
        name: generalName,
        client: client || null,
        creator: creator,
        description: description || null
    };
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
    
    try {
        const response = await fetch('/api/v1/quotation/general', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`ê²¬ì ì„œ(ì¼ë°˜)ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nID: ${data.id}`);
            window.location.href = `/service/quotation/general/form?mode=view&id=${data.id}`;
        } else {
            const error = await response.json();
            alert('ë“±ë¡ ì‹¤íŒ¨: ' + (error.detail || JSON.stringify(error)));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ë“±ë¡ì™„ë£Œ';
    }
}

function goToList() {
    window.location.href = '/service/quotation/general';
}
</script>

<style>
/* í˜ì´ì§€ ì»¨í…ì¸  */
.page-content {
    background-color: #fff;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* ìƒì„± í—¤ë” */
.create-header {
    margin-bottom: 24px;
}

.create-header h2 {
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 16px 0;
    color: #1f2937;
}

.header-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
}

.required {
    color: #ef4444;
}

.form-input {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.form-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input:read-only {
    background-color: #f9fafb;
    cursor: not-allowed;
}

/* êµ¬ë¶„ì„  */
.divider {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 32px 0;
}

/* ì„¹ì…˜ í—¤ë” */
.section-header {
    margin-bottom: 16px;
}

.section-header h3 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: #1f2937;
}

.section-description {
    font-size: 14px;
    color: #6b7280;
    margin: 0;
}

/* ë±ƒì§€ */
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.badge-primary { background-color: #dbeafe; color: #1e40af; }
.badge-info { background-color: #e0e7ff; color: #4338ca; }
.badge-warning { background-color: #fef3c7; color: #92400e; }

/* í…Œì´ë¸” í–‰ í˜¸ë²„ */
.data-table tbody tr.clickable {
    cursor: pointer;
    transition: background-color 0.2s;
}

.data-table tbody tr.clickable:hover {
    background-color: #f3f4f6;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
    font-size: 14px;
}

/* ì•¡ì…˜ í‘¸í„° */
.action-footer {
    display: flex;
    justify-content: space-between; /* ì–‘ ë ì •ë ¬ */
    align-items: center;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid #e5e7eb;
}

.derivative-group {
    display: flex;
    gap: 8px;
}

.right-group {
    display: flex;
    gap: 12px;
}

.btn-lg {
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 600;
}

.btn-success {
    background-color: #10b981;
    color: white;
    border: none;
}

.btn-success:hover {
    background-color: #059669;
}

.btn-success:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 1024px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    .action-footer {
        flex-direction: column;
        gap: 16px;
    }
    .derivative-group, .right-group {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}