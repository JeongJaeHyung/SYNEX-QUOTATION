<!--app/frontend/template/machine_detail.html-->

{% extends "template/base.html" %}

{% block title %}장비 견적서 상세 - SYNEX+{% endblock %}

{% block content %}
<div class="page-content">
    {# 로딩 #}
    <div id="loading" style="display: block; text-align: center; padding: 40px;">
        <p>데이터를 불러오는 중...</p>
    </div>

    {# 에러 메시지 #}
    <div id="errorMessage" style="display: none; text-align: center; padding: 40px; color: #ef4444;">
        <h3>데이터를 불러올 수 없습니다</h3>
        <p id="errorDetail"></p>
        <button class="btn btn-primary" onclick="window.location.href='/service/quotation/maintenance/list'">목록으로</button>
    </div>

    {# 상세 정보 #}
    <div id="detailContainer" style="display: none;">
        {# 헤더 #}
        <div class="detail-header">
            <div class="detail-title">
                <h2 id="machineName"></h2>
                <span class="badge badge-info" id="machineId"></span>
            </div>
            <div class="detail-actions">
                <button class="btn btn-secondary" onclick="goToList()">목록</button>
                <button class="btn btn-primary" onclick="editMachine()">수정</button>
                <button class="btn btn-danger" onclick="downloadPDF()">PDF 다운로드</button>
            </div>
        </div>

        {# 기본 정보 #}
        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <label>작성자</label>
                    <span id="creator"></span>
                </div>
                <div class="info-item">
                    <label>생성일</label>
                    <span id="createdAt"></span>
                </div>
                <div class="info-item">
                    <label>수정일</label>
                    <span id="updatedAt"></span>
                </div>
                <div class="info-item">
                    <label>총 금액</label>
                    <span id="totalPrice" class="price-text"></span>
                </div>
            </div>
            <div class="info-description">
                <label>비고</label>
                <p id="description"></p>
            </div>
        </div>

        <hr class="divider">

        {# 구성 부품 목록 #}
        <div class="resources-section">
            <h3>구성 부품 (<span id="resourceCount">0</span>개)</h3>
            <div id="resourcesTable"></div>
        </div>
    </div>
</div>

<script>
// URL에서 machine_id 추출
const pathParts = window.location.pathname.split('/');
const machineId = pathParts[pathParts.length - 1];

// 페이지 로드 시 데이터 가져오기
document.addEventListener('DOMContentLoaded', function() {
    loadMachineDetail();
});

// 장비 견적서 상세 정보 로드
async function loadMachineDetail() {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');
    const detailContainer = document.getElementById('detailContainer');
    
    try {
        // API 호출 - 템플릿 리터럴 사용!
        const response = await fetch(`/api/v1/quotation/machine/${machineId}?include_schema=true`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Machine Detail:', data);
        
        // 데이터 렌더링
        renderMachineDetail(data);
        
        // 표시 전환
        loading.style.display = 'none';
        detailContainer.style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        loading.style.display = 'none';
        errorMessage.style.display = 'block';
        document.getElementById('errorDetail').textContent = error.message;
    }
}

// 상세 정보 렌더링
function renderMachineDetail(data) {
    // 기본 정보
    document.getElementById('machineName').textContent = data.name || '-';
    document.getElementById('machineId').textContent = data.id || '-';
    document.getElementById('creator').textContent = data.creator || '-';
    document.getElementById('createdAt').textContent = formatDateTime(data.created_at);
    document.getElementById('updatedAt').textContent = formatDateTime(data.updated_at);
    document.getElementById('totalPrice').textContent = formatCurrency(data.total_price || 0);
    document.getElementById('description').textContent = data.description || '비고 없음';
    document.getElementById('resourceCount').textContent = data.resource_count || 0;
    
    // 구성 부품 테이블
    if (data.resources) {
        if (data.resources.schema && data.resources.items) {
            // schema가 있는 경우
            renderResourcesTable(data.resources.schema, data.resources.items);
        } else if (Array.isArray(data.resources)) {
            // schema가 없는 경우
            renderResourcesTableSimple(data.resources);
        }
    }
}

// 부품 테이블 렌더링 (스키마 있음)
function renderResourcesTable(schema, items) {
    const container = document.getElementById('resourcesTable');
    
    if (!items || items.length === 0) {
        container.innerHTML = '<div class="empty-state">구성 부품이 없습니다</div>';
        return;
    }
    
    // ratio 합계 계산
    let totalRatio = 0;
    for (const key in schema) {
        totalRatio += schema[key].ratio || 1;
    }
    
    let html = '<div class="table-container"><table class="data-table">';
    
    // 헤더
    html += '<thead><tr>';
    for (const key in schema) {
        const col = schema[key];
        const width = ((col.ratio || 1) / totalRatio * 100).toFixed(1);
        const align = col.align || (col.type === 'integer' ? 'right' : (col.type === 'boolean' ? 'center' : 'left'));
        html += `<th class="col-${align}" style="width: ${width}%">${col.title}</th>`;
    }
    html += '</tr></thead><tbody>';
    
    // 데이터 행
    items.forEach(item => {
        html += '<tr>';
        for (const key in schema) {
            const col = schema[key];
            const value = item[key];
            const align = col.align || (col.type === 'integer' ? 'right' : (col.type === 'boolean' ? 'center' : 'left'));
            
            html += `<td class="col-${align}">`;
            html += formatValue(value, col.type, col.format);
            html += '</td>';
        }
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 부품 테이블 렌더링 (스키마 없음)
function renderResourcesTableSimple(items) {
    const container = document.getElementById('resourcesTable');
    
    if (!items || items.length === 0) {
        container.innerHTML = '<div class="empty-state">구성 부품이 없습니다</div>';
        return;
    }
    
    let html = '<div class="table-container"><table class="data-table">';
    
    // 헤더
    html += `<thead><tr>
        <th>품목코드</th>
        <th>제조사</th>
        <th>대분류</th>
        <th>중분류</th>
        <th>모델명</th>
        <th>단위</th>
        <th class="col-right">단가</th>
        <th class="col-center">수량</th>
        <th class="col-right">소계</th>
    </tr></thead><tbody>`;
    
    // 데이터 행
    items.forEach(item => {
        html += `<tr>
            <td>${item.item_code || '-'}</td>
            <td>${item.maker_name || '-'}</td>
            <td>${item.category_major || '-'}</td>
            <td>${item.category_minor || '-'}</td>
            <td>${item.model_name || item.name || '-'}</td>
            <td>${item.unit || '-'}</td>
            <td class="col-right">${formatCurrency(item.solo_price || 0)}</td>
            <td class="col-center">${item.quantity || 0}</td>
            <td class="col-right">${formatCurrency(item.subtotal || 0)}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// 값 포맷팅
function formatValue(value, type, format) {
    if (value === null || value === undefined || value === '') {
        return '<span class="text-muted">-</span>';
    }
    
    switch(type) {
        case 'boolean':
            return value ? 
                '<span class="badge badge-success">O</span>' : 
                '<span class="badge badge-default">X</span>';
        
        case 'integer':
            if (format === 'currency') {
                return formatCurrency(value);
            }
            return value.toLocaleString('ko-KR');
        
        case 'datetime':
            return formatDateTime(value);
        
        default:
            return value;
    }
}

// 날짜 시간 포맷
function formatDateTime(datetime) {
    if (!datetime) return '-';
    const date = new Date(datetime);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}. ${month}. ${day} ${hours}:${minutes}`;
}

// 통화 포맷
function formatCurrency(value) {
    if (!value && value !== 0) return '-';
    return value.toLocaleString('ko-KR') + '원';
}

// 목록으로
function goToList() {
    window.location.href = '/service/quotation/maintenance/list';
}

// 수정
function editMachine() {
    alert('수정 기능은 구현 예정입니다.');
    // TODO: 수정 페이지로 이동
    // window.location.href = `/service/quotation/maintenance/${machineId}/edit`;
}

// PDF 다운로드
function downloadPDF() {
    alert('PDF 다운로드 기능은 구현 예정입니다.');
    // TODO: PDF 생성 API 호출
}
</script>

<style>
/* 페이지 컨텐츠 */
.page-content {
    background-color: #fff;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* 상세 헤더 */
.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e5e7eb;
}

.detail-title h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    color: #1f2937;
}

.detail-title .badge {
    font-size: 12px;
    padding: 4px 8px;
}

.detail-actions {
    display: flex;
    gap: 8px;
}

/* 정보 섹션 */
.info-section {
    background-color: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 16px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.info-item label {
    font-size: 13px;
    font-weight: 500;
    color: #6b7280;
}

.info-item span {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
}

.price-text {
    color: #2563eb !important;
    font-size: 18px !important;
}

.info-description {
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.info-description label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 8px;
}

.info-description p {
    font-size: 14px;
    color: #374151;
    margin: 0;
    line-height: 1.6;
}

.divider {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin: 32px 0;
}

/* 부품 섹션 */
.resources-section h3 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 16px 0;
    color: #1f2937;
}

/* 반응형 */
@media (max-width: 1024px) {
    .detail-header {
        flex-direction: column;
        gap: 16px;
    }
    
    .info-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 640px) {
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .detail-actions {
        width: 100%;
        flex-direction: column;
    }
    
    .detail-actions .btn {
        width: 100%;
    }
}
</style>
{% endblock %}