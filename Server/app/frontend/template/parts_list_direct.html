{% extends "template/base.html" %}

{% block title %}부품/자재 목록 - SYNEX+{% endblock %}

{% block content %}
<div class="page-content">
    {# 상단 액션 바 #}
    <div class="action-bar">
        <div class="action-bar-left">
            <button class="btn btn-primary" onclick="openCreatePopup()">
                <span>+</span> 부품 등록
            </button>
            <button class="btn btn-danger" onclick="deleteSelected()">
                선택 삭제
            </button>
        </div>
        <div class="action-bar-right">
            <select class="input-select" id="categoryFilter" onchange="loadData()">
                <option value="">전체 카테고리</option>
                <option value="판넬">판넬</option>
                <option value="잡재료 및 케이블">잡재료 및 케이블</option>
            </select>
            <input type="text" class="input-search" placeholder="검색어를 입력해 주세요" id="searchInput" onkeypress="handleSearch(event)">
            <button class="btn btn-primary" onclick="loadData()">검색하기</button>
        </div>
    </div>

    {# 로딩 인디케이터 #}
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <p>데이터를 불러오는 중...</p>
    </div>

    {# 테이블 컨테이너 #}
    <div id="tableContainer"></div>
    
    {# 페이지네이션 #}
    <div id="pagination" style="display: none;" class="pagination">
        <span class="pagination-info" id="pageInfo"></span>
        <div class="pagination-buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="goToPrevPage()">이전</button>
            <button class="btn btn-secondary" id="nextBtn" onclick="goToNextPage()">다음</button>
        </div>
    </div>
</div>

<script>
let currentSkip = 0;
let currentLimit = 20;
let totalItems = 0;

// 페이지 로드 시 데이터 가져오기
document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

// 데이터 로드
async function loadData() {
    const loading = document.getElementById('loading');
    const tableContainer = document.getElementById('tableContainer');
    const pagination = document.getElementById('pagination');
    
    // 로딩 표시
    loading.style.display = 'block';
    tableContainer.innerHTML = '';
    pagination.style.display = 'none';
    
    // 검색 조건
    const searchQuery = document.getElementById('searchInput').value;
    const category = document.getElementById('categoryFilter').value;
    
    // API URL 구성
    let apiUrl = '/api/v1/parts?include_schema=true';
    apiUrl += `&skip=${currentSkip}&limit=${currentLimit}`;
    
    if (searchQuery) {
        apiUrl += `&name=${encodeURIComponent(searchQuery)}`;
    }
    if (category) {
        apiUrl += `&major=${encodeURIComponent(category)}`;
    }
    
    try {
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error('API 호출 실패');
        }
        
        const data = await response.json();
        
        // 데이터 저장
        totalItems = data.total || 0;
        
        // 테이블 렌더링
        renderTable(data.schema, data.items);
        
        // 페이지네이션 업데이트
        updatePagination();
        
    } catch (error) {
        console.error('Error:', error);
        tableContainer.innerHTML = `
            <div class="empty-state" style="color: #ef4444;">
                데이터를 불러오는데 실패했습니다.<br>
                <small>${error.message}</small>
            </div>
        `;
    } finally {
        loading.style.display = 'none';
    }
}

// 테이블 렌더링
function renderTable(schema, items) {
    const tableContainer = document.getElementById('tableContainer');
    
    if (!items || items.length === 0) {
        tableContainer.innerHTML = '<div class="empty-state">데이터가 없습니다</div>';
        return;
    }
    
    // ratio 합계 계산
    let totalRatio = 0;
    for (const key in schema) {
        totalRatio += schema[key].ratio || 1;
    }
    
    // 테이블 HTML 생성
    let html = '<div class="table-container"><table class="data-table" id="partsTable">';
    
    // 헤더
    html += '<thead><tr>';
    html += '<th class="col-center" style="width: 50px"><input type="checkbox" id="checkAll" onchange="toggleAllRows()"></th>';
    
    for (const key in schema) {
        const col = schema[key];
        const width = ((col.ratio || 1) / totalRatio * 100).toFixed(1);
        const align = col.align || (col.type === 'integer' ? 'right' : (col.type === 'boolean' ? 'center' : 'left'));
        html += `<th class="col-${align}" style="width: ${width}%">${col.title}</th>`;
    }
    
    html += '</tr></thead><tbody>';
    
    // 데이터 행
    items.forEach((item, index) => {
        const rowId = item.item_code || item.id || index;
        html += `<tr class="clickable" data-row-id="${rowId}" onclick="goToDetail('${rowId}')">`;
        html += `<td class="col-center" onclick="event.stopPropagation()"><input type="checkbox" class="row-checkbox" value="${rowId}"></td>`;
        
        for (const key in schema) {
            const col = schema[key];
            const value = item[key];
            const align = col.align || (col.type === 'integer' ? 'right' : (col.type === 'boolean' ? 'center' : 'left'));
            
            html += `<td class="col-${align}">`;
            html += formatValue(value, col.type, col.format);
            html += '</td>';
        }
        
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    tableContainer.innerHTML = html;
}

// 값 포맷팅
function formatValue(value, type, format) {
    if (value === null || value === undefined || value === '') {
        return '<span class="text-muted">-</span>';
    }
    
    switch(type) {
        case 'boolean':
            return value ? 
                '<span class="badge badge-success">O</span>' : 
                '<span class="badge badge-default">X</span>';
        
        case 'integer':
            if (format === 'currency') {
                return value.toLocaleString('ko-KR');
            }
            return value.toLocaleString('ko-KR');
        
        case 'datetime':
            if (format === 'YYYY-MM-DD HH:mm') {
                return value.substring(0, 16).replace('T', ' ');
            }
            return value;
        
        case 'date':
            return value.substring(0, 10).replace(/-/g, '. ');
        
        default:
            return value;
    }
}

// 페이지네이션 업데이트
function updatePagination() {
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (totalItems > currentLimit) {
        pagination.style.display = 'flex';
        
        const start = currentSkip + 1;
        const end = Math.min(currentSkip + currentLimit, totalItems);
        pageInfo.textContent = `전체 ${totalItems}개 중 ${start} - ${end}`;
        
        prevBtn.disabled = currentSkip === 0;
        nextBtn.disabled = currentSkip + currentLimit >= totalItems;
    } else {
        pagination.style.display = 'none';
    }
}

// 이전 페이지
function goToPrevPage() {
    if (currentSkip >= currentLimit) {
        currentSkip -= currentLimit;
        loadData();
    }
}

// 다음 페이지
function goToNextPage() {
    if (currentSkip + currentLimit < totalItems) {
        currentSkip += currentLimit;
        loadData();
    }
}

// 검색 (Enter 키)
function handleSearch(event) {
    if (event.key === 'Enter') {
        currentSkip = 0; // 검색 시 첫 페이지로
        loadData();
    }
}

// 전체 체크박스 토글
function toggleAllRows() {
    const checkAll = document.getElementById('checkAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = checkAll.checked);
}

// 선택된 행 가져오기
function getSelectedRows() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// 상세 페이지로 이동
function goToDetail(itemCode) {
    const parts = itemCode.split('-');
    if (parts.length === 2) {
        window.location.href = `/service/parts/${parts[1]}/${parts[0]}`;
    } else {
        alert('상세 페이지로 이동: ' + itemCode);
    }
}

// 부품 등록 팝업
function openCreatePopup() {
    alert('부품 등록 팝업 (구현 예정)');
}

// 선택 삭제
function deleteSelected() {
    const selected = getSelectedRows();
    if (selected.length === 0) {
        alert('선택된 항목이 없습니다');
        return;
    }
    
    if (confirm(`${selected.length}개 항목을 삭제하시겠습니까?`)) {
        // TODO: API 호출
        console.log('삭제할 항목:', selected);
        alert('삭제 API 연동 예정');
    }
}
</script>

<style>
/* 페이지 컨텐츠 */
.page-content {
    background-color: #fff;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* 액션 바 */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
}

.action-bar-left,
.action-bar-right {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-bar-right .input-search {
    min-width: 300px;
}

.input-select {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    min-width: 150px;
}

.input-select:focus {
    outline: none;
    border-color: #2563eb;
}

/* 페이지네이션 */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.pagination-info {
    color: #6b7280;
    font-size: 14px;
}

.pagination-buttons {
    display: flex;
    gap: 8px;
}

.pagination-buttons button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .action-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-bar-left,
    .action-bar-right {
        width: 100%;
        flex-wrap: wrap;
    }
    
    .input-search,
    .input-select {
        flex: 1;
        min-width: 0;
    }
}
</style>
{% endblock %}